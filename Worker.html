<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks - Smart Garbage App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-green-dark: #006400;
            --primary-green: #008000;
            --accent-lime: #90D26D;
            --accent-green-hover: #549957;
            --background-start: #f8fafc;
            --background-end: #eef7f0;
            --card-background: #FFFFFF;
            --text-dark: #212121;
            --text-light: #5f6368;
            --text-white: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', 'Roboto', sans-serif;
            --border-radius: 20px;
            --transition-speed: 0.3s ease;
            --error-red: #D32F2F;
            --success-green: #2E7D32;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .app-header {
            width: 100%;
            background: linear-gradient(90deg, var(--primary-green-dark) 0%, var(--primary-green) 100%);
            color: var(--text-white);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0 2rem;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-brand {
            font-size: 1.15rem;
            font-weight: 600;
            text-decoration: none;
            color: var(--text-white);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-nav {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text-white);
            font-weight: 500;
            font-size: 0.95rem;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all var(--transition-speed);
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }
        .nav-link.active {
            background-color: var(--accent-lime);
            color: var(--primary-green-dark);
            font-weight: 700;
        }
        .nav-link svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .btn-logout-header {
            background: none;
            border: none;
            color: var(--text-white);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            margin-left: 1rem;
        }
        .btn-logout-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        .btn-logout-header svg {
            width: 24px;
            height: 24px;
            fill: var(--text-white);
            display: block;
        }
        .mobile-menu-toggle { display: none; }
        .app-content-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 2.5rem 1.5rem;
        }
        main.app-content {
            width: 100%;
            max-width: 700px; /* Worker list can be wider */
            animation: fadeIn 0.4s var(--transition-speed) both;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .app-footer {
            width: 100%;
            padding: 1.5rem 1rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
            background-color: transparent;
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
        }
        
        /* Page-Specific: Worker Page */
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 24px;
        }
        
        #loading-message, .empty-list-message {
            font-size: 1rem;
            color: var(--text-light);
            text-align: center;
            padding: 2rem 0;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .task-card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border-color); /* Added subtle border */
        }
        
        .task-image {
            width: 100%;
            height: 220px; /* Taller image */
            object-fit: cover;
            background-color: #f0f0f0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .task-content {
            padding: 20px;
        }
        .task-content h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        .task-content p {
            font-size: 0.95rem;
            color: var(--text-light);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .task-content .location {
            font-weight: 600; /* Bolder */
            font-size: 1rem; /* Larger */
            color: var(--primary-green);
            display: block; /* On its own line */
            margin-bottom: 12px;
        }
        
        .task-form {
            border-top: 1px solid var(--border-color);
            padding: 20px;
            background: #fafafa;
        }
        .form-label {
            font-size: 0.9rem;
            font-weight: 600; /* Bolder */
            color: var(--text-dark); /* Darker */
            margin-bottom: 8px;
            display: block;
        }

        input[type="file"] {
            display: none;
        }
        .file-input-label {
            display: block;
            background: var(--card-background);
            text-align: center;
            padding: 12px;
            border: 2px dashed var(--border-color); /* Thicker dash */
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 500;
            transition: all var(--transition-speed);
        }
        .file-input-label:hover {
            border-color: var(--primary-green);
            color: var(--primary-green);
            background-color: #fdfdfd;
        }
        .file-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
            margin-top: 10px;
            display: block;
            text-align: center;
        }
        .btn-complete {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all var(--transition-speed);
            background-color: var(--success-green); /* Darker green */
            color: var(--text-white);
            margin-top: 12px;
        }
        .btn-complete:hover {
            background-color: var(--primary-green-dark); /* Darker hover */
        }
        .btn-complete:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
        }

        /* Toast */
        .toast-message {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: var(--shadow);
            z-index: 2000;
            transition: bottom 0.5s ease;
        }
        .toast-message.show { bottom: 30px; } /* Lowered */
        .toast-success {
            background-color: var(--success-green);
            color: white;
        }
        .toast-error {
            background-color: var(--error-red);
            color: white;
        }
        
        /* Camera Modal (Copied from report.html, just in case) */
        .camera-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }
        /* ... other camera styles if needed ... */


        @media (max-width: 768px) {
            .app-header { padding: 0 1rem; }
            .header-nav { display: none; }
            .mobile-menu-toggle { 
                display: block; 
                background: none; 
                border: none; 
                color: white; 
                cursor: pointer;
            }
            .header-nav-mobile {
                display: flex;
                flex-direction: column;
                position: absolute;
                top: 64px; left: 0; width: 100%;
                background: var(--card-background);
                box-shadow: var(--shadow);
                animation: slideDown 0.3s ease-out;
                padding: 1rem 0;
                z-index: 99;
            }
            @keyframes slideDown {
                from { transform: translateY(-20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .header-nav-mobile .nav-link {
                color: var(--text-dark);
                padding: 1rem 1.5rem;
                border-radius: 0;
            }
            .header-nav-mobile .nav-link.active {
                background-color: var(--background-end);
                color: var(--primary-green);
            }
            .header-nav-mobile .btn-logout-header {
                color: var(--text-dark);
                width: 100%;
                padding: 1rem 1.5rem;
                text-align: left;
                border-radius: 0;
                margin: 0;
            }
            .header-nav-mobile .btn-logout-header svg {
                fill: var(--text-dark);
            }
        }
        @media (max-width: 600px) {
            .header-brand {
                font-size: 1.05rem;
                text-align: left;
                flex: 1;
            }
            .page-title {
                font-size: 1.5rem; /* Smaller title */
            }
            .task-content { padding: 16px; }
            .task-form { padding: 16px; }
        }
    </style>
</head>
<body id="body">
    
    <header class="app-header">
        <a href="/worker" class="header-brand">‚ôªÔ∏è Smart Garbage Reporting</a>
        
        <nav class="header-nav" id="desktop-nav">
            <!-- Welcome message injected here -->
            <span id="welcome-user" class="nav-link" style="opacity: 1; font-weight: 600; color: var(--text-white);">Welcome!</span>
            
            <a href="/worker" class="nav-link active" title="My Tasks">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h160v-80h240v80h160q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Z"/></svg>
                <span>My Tasks</span>
            </a>
            <!-- UPDATED: Link now points to /worker_profile -->
            <a href="/worker_profile" class="nav-link" title="Profile">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/></svg>
                <span>Profile</span>
            </a>
            
            <button class="btn-logout-header" id="logout-button-header" title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/></svg>
            </button>
        </nav>

        <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Open navigation menu">
            <svg xmlns="http://www.w3.org/2000/svg" height="28" viewBox="0 -960 960 960" width="28" fill="currentColor"><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/></svg>
        </button>
    </header>

    <nav class="header-nav-mobile" id="mobile-nav" style="display: none;"></nav>

    <div class="app-content-wrapper">
        <main class="app-content">

            <h1 class="page-title" id="welcome-title">Welcome, Worker!</h1>
            
            <div class="task-list" id="worker-task-list">
                <p id="loading-message">Loading assigned tasks...</p>
                <!-- Worker task cards will be injected here by JavaScript -->
            </div>

        </main>
    </div>

    <!-- Toast message container (hidden) -->
    <div id="toast-message" class="toast-message"></div>

    <footer class="app-footer">
        &copy; 2025 Smart Garbage Reporting
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            
            // --- 1. Auth Check ---
            if (!token) {
                window.location.href = '/login';
                return; 
            }
            
            // --- 2. Get Elements ---
            const taskListContainer = document.getElementById('worker-task-list');
            const loadingMessage = document.getElementById('loading-message');
            const welcomeUser = document.getElementById('welcome-user');
            const welcomeTitle = document.getElementById('welcome-title');
            const toastMessage = document.getElementById('toast-message');
            
            // --- 3. Setup Worker User Info ---
            const username = localStorage.getItem('username') || 'Worker';
            if (welcomeUser) {
                welcomeUser.textContent = `Welcome, ${username}!`;
            }
            if (welcomeTitle) {
                welcomeTitle.textContent = `Welcome, ${username}!`;
            }

            // --- 4. Logout & Nav (from report.html) ---
            const handleLogout = (e) => {
                e.preventDefault();
                localStorage.removeItem('authToken');
                localStorage.removeItem('username');
                localStorage.removeItem('userEmail');
                window.location.href = '/login';
            };
            
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileNav = document.getElementById('mobile-nav');
            const desktopNav = document.getElementById('desktop-nav');
            
            if (mobileMenuToggle && mobileNav && desktopNav) {
                mobileMenuToggle.addEventListener('click', () => {
                    const isNavOpen = mobileNav.style.display === 'flex';
                    if (isNavOpen) {
                        mobileNav.style.display = 'none';
                    } else {
                        mobileNav.innerHTML = desktopNav.innerHTML;
                        mobileNav.style.display = 'flex';
                        // Re-attach logout listener to the new mobile button
                        const mobileLogoutBtn = mobileNav.querySelector('.btn-logout-header');
                        if (mobileLogoutBtn) {
                            mobileLogoutBtn.addEventListener('click', handleLogout);
                        }
                    }
                });
            }
            
            const logoutButtonHeader = document.getElementById('logout-button-header');
            if (logoutButtonHeader) {
                logoutButtonHeader.addEventListener('click', handleLogout);
            }
            
            // --- 5. Show Toast Message (from report.html) ---
            const showToast = (message, type = 'success') => {
                toastMessage.textContent = message;
                toastMessage.className = `toast-message ${type === 'success' ? 'toast-success' : 'toast-error'}`;
                toastMessage.classList.add('show');
                setTimeout(() => {
                    toastMessage.classList.remove('show');
                }, 3000);
            };

            // --- 6. Helper function to create task card ---
            const createTaskCard = (task) => {
                // Handle missing image
                const imageUrl = task.image_url ? `/uploads/${task.image_url}` : 'https://placehold.co/600x220/e0e0e0/757575?text=No+Image';
                const imageOnError = `this.onerror=null;this.src='https://placehold.co/600x220/e0e0e0/757575?text=Image+Missing';`;

                return `
                    <div class="task-card" id="task-card-${task.id}">
                        <img src="${imageUrl}" alt="Report image" class="task-image" onerror="${imageOnError}">
                        <div class="task-content">
                            <h3>Task #${task.id} (from ${task.user_email || 'N/A'})</h3>
                            <span class="location">üìç ${task.location_lat}, ${task.location_lon}</span>
                            <p>${task.description || 'No description provided.'}</p>
                        </div>
                        <form class="task-form" data-id="${task.id}">
                            <label class="form-label" for="photo-input-${task.id}">Upload Completion Photo</label>
                            <label for="photo-input-${task.id}" class="file-input-label">
                                Choose File
                                <span class="file-name" id="file-name-${task.id}">No file chosen</span>
                            </label>
                            <input type="file" id="photo-input-${task.id}" class="photo-input" accept="image/jpeg, image/png" required>
                            
                            <button type="submit" class="btn-complete">Mark as Completed</button>
                        </form>
                    </div>
                `;
            };

            // --- 7. Fetch Tasks from Backend ---
            const fetchWorkerTasks = async () => {
                try {
                    const response = await fetch('/api/worker/tasks', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) { // Unauthorized or Forbidden
                            localStorage.clear();
                            window.location.href = '/login';
                        }
                        throw new Error(`Server error: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    loadingMessage.style.display = 'none';
                    taskListContainer.innerHTML = ''; // Clear loading message

                    if (data.tasks && data.tasks.length > 0) {
                        data.tasks.forEach(task => {
                            taskListContainer.innerHTML += createTaskCard(task);
                        });
                    } else {
                        taskListContainer.innerHTML = '<p class="empty-list-message">You have no pending tasks. Good job!</p>';
                    }
                } catch (error) {
                    console.error('Failed to fetch tasks:', error);
                    loadingMessage.textContent = 'Failed to load tasks. Please try again later.';
                    loadingMessage.style.color = 'red';
                }
            };

            // --- 8. Handle Task Completion ---
            taskListContainer.addEventListener('submit', async (e) => {
                if (e.target.classList.contains('task-form')) {
                    e.preventDefault();
                    
                    const reportId = e.target.dataset.id;
                    const photoInput = document.getElementById(`photo-input-${reportId}`);
                    const submitButton = e.target.querySelector('.btn-complete');

                    if (photoInput.files.length === 0) {
                        showToast('Please upload a completion photo.', 'error');
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';

                    const formData = new FormData();
                    formData.append('completion_image', photoInput.files[0]);

                    try {
                        const response = await fetch(`/api/worker/task/${reportId}/complete`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.msg || 'Completion failed');
                        }

                        showToast('Task completed successfully!', 'success');
                        fetchWorkerTasks(); // Refresh the task list

                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Mark as Completed';
                    }
                }
            });
            
            // --- 9. Handle File Input Label Change ---
            taskListContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('photo-input')) {
                    const reportId = e.target.id.split('-')[2];
                    const fileNameSpan = document.getElementById(`file-name-${reportId}`);
                    if (e.target.files.length > 0) {
                        fileNameSpan.textContent = e.target.files[0].name;
                    } else {
                        fileNameSpan.textContent = 'No file chosen';
                    }
                }
            });

            // --- 10. Initial Call ---
            fetchWorkerTasks();
        });
    </script>

</body>
</html>