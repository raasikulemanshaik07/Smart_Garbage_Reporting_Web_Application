<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up - Smart Garbage App</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    /* --- USER'S NEW THEME --- */
    :root {
        --primary-green-dark: #006400;
        --primary-green: #008000;
        --background-start: #f8fafc;
        --background-end: #eef7f0;
        --card-background: #FFFFFF;
        --text-dark: #212121;
        --text-light: #5f6368;
        --text-white: #FFFFFF;
        --border-color: #E0E0E0;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --font-family: 'Poppins', 'Roboto', sans-serif;
        --border-radius: 12px;
        --transition-speed: 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--background-start), var(--background-end));
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 2rem;
    }

    .app-screen {
        width: 100%;
        max-width: 420px;
    }

    .signup-container h1 {
        text-align: center;
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 2rem;
    }

    .card {
        background: var(--card-background);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 32px;
    }

    .form-group { margin-bottom: 18px; }

    .form-label {
        display: block;
        margin-bottom: 6px;
        color: var(--text-dark);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .form-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        transition: 0.2s;
        /* --- ADDED: Background color for visibility --- */
        background-color: #fcfcfc;
    }

    .form-input:focus {
        border-color: var(--primary-green);
        outline: none;
        box-shadow: 0 0 0 2px rgba(0,128,0,0.15);
    }

    /* Input Group Fix */
    .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-group .form-input {
        flex: 1;
        height: 45px;
    }

    .input-group .btn-small {
        height: 45px;
        white-space: nowrap;
        padding: 0 18px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        font-size: 0.9rem;
        border: none;
    }

    .btn-small.btn-secondary {
        background-color: #eaeaea;
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }

    .btn-small.btn-secondary:hover:not([disabled]) {
        background-color: #dcdcdc;
    }
    
    /* --- ADDED: Style for verified button --- */
    .btn-small.btn-verified {
        background-color: var(--primary-green);
        color: var(--text-white);
        cursor: not-allowed;
    }

    .btn-primary {
        background-color: var(--primary-green);
        color: var(--text-white);
        font-weight: 700;
        padding: 14px;
        width: 100%;
        border-radius: 8px;
        border: none;
        transition: 0.3s;
        font-size: 1rem;
    }

    .btn-primary:hover:not([disabled]) {
        background-color: var(--primary-green-dark);
    }

    .btn[disabled] {
        background-color: #BDBDBD;
        cursor: not-allowed;
    }

    .divider {
        height: 1px;
        background: var(--border-color);
        margin: 1.5rem 0;
    }

    .message-box {
        margin-top: 1rem;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        display: none;
    }

    .error-message {
        color: #D32F2F;
        background: rgba(211,47,47,0.1);
    }

    .success-message {
        color: #2E7D32;
        background: rgba(46,125,50,0.1);
    }

    .login-link-btn {
        display: block;
        text-align: center;
        color: var(--primary-green);
        margin-top: 1rem;
        font-weight: 500;
        text-decoration: none;
    }

    .login-link-btn:hover {
        text-decoration: underline;
    }

    footer {
        margin-top: 2rem;
        font-size: 0.8rem;
        color: var(--text-light);
        text-align: center;
    }
</style>
</head>
<body>
<div class="app-screen">
    <main class="signup-container">
        <h1>Create Your Account</h1>
        <div class="card">
            <form id="signup-form">
                
                <div class="form-group">
                    <label class="form-label" for="username">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="e.g., JohnDoe" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="you@example.com" required>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label class="form-label" for="phone-number">Mobile Number (India: +91)</label>
                    <div class="input-group">
                        <input type="tel" id="phone-number" class="form-input" placeholder="10-digit number" required maxlength="10" pattern="[6-9][0-9]{9}">
                        <button type="button" id="send-otp-button" class="btn-small btn-secondary">Send OTP</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="otp-code">Enter 6-Digit OTP</label>
                    <div class="input-group">
                        <input type="number" id="otp-code" class="form-input" placeholder="123456" required maxlength="6" disabled>
                        <button type="button" id="verify-otp-button" class="btn-small btn-secondary" disabled>Verify</button>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Min. 8 characters" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" class="form-input" placeholder="Re-type your password" required>
                </div>

                <button type="submit" id="signup-button" class="btn-primary" disabled>Create Account</button>
            </form>
        </div>
        <a href="/login" class="login-link-btn">Already have an account? Login</a>
        <div id="message-box" class="message-box"></div>
    </main>
    <footer>&copy; 2025 Smart Garbage Reporting | Keep Your City Clean ♻️</footer>
</div>

<!-- --- ADDED: JavaScript logic from our previous version --- -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const signupForm = document.getElementById("signup-form");
        const signupButton = document.getElementById("signup-button");
        const messageBox = document.getElementById("message-box");
        
        const phoneInput = document.getElementById("phone-number");
        const sendOtpButton = document.getElementById("send-otp-button");
        const otpInput = document.getElementById("otp-code");
        const verifyOtpButton = document.getElementById("verify-otp-button");
        
        const usernameInput = document.getElementById("username");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const confirmPasswordInput = document.getElementById("confirm-password");

        const showMessage = (message, type) => {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}-message`;
            messageBox.style.display = "block";
        };

        // --- Event Listener for Send OTP Button ---
        sendOtpButton.addEventListener("click", async () => {
            const phone_number = phoneInput.value;
            
            if (phone_number.length !== 10 || !/^[6-9][0-9]{9}$/.test(phone_number)) {
                showMessage("Please enter a valid 10-digit Indian mobile number.", "error");
                return;
            }
            
            sendOtpButton.disabled = true;
            sendOtpButton.textContent = "Sending...";
            messageBox.style.display = "none";
            
            try {
                const response = await fetch('/api/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phone_number })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.msg || 'Failed to send OTP.');
                }
                
                showMessage(data.msg, "success");
                phoneInput.disabled = true; // Lock the phone number
                otpInput.disabled = false; // Enable OTP input
                verifyOtpButton.disabled = false; // Enable Verify button
                sendOtpButton.textContent = "Resend"; // Change button text
                sendOtpButton.disabled = false; // Re-enable for resend

            } catch (error) {
                showMessage(error.message, "error");
                sendOtpButton.disabled = false;
                sendOtpButton.textContent = "Send OTP";
            }
        });

        // --- Event Listener for Verify OTP Button ---
        verifyOtpButton.addEventListener("click", async () => {
            const phone_number = phoneInput.value;
            const otp_code = otpInput.value;

            if (otp_code.length !== 6) {
                showMessage("Please enter the 6-digit OTP.", "error");
                return;
            }

            verifyOtpButton.disabled = true;
            verifyOtpButton.textContent = "Verifying...";
            messageBox.style.display = "none";

            try {
                const response = await fetch('/api/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phone_number, otp: otp_code })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.msg || 'Invalid OTP.');
                }
                
                showMessage(data.msg, "success");
                // --- MODIFIED: Lock OTP fields and enable signup ---
                otpInput.disabled = true;
                verifyOtpButton.textContent = "Verified ✓";
                verifyOtpButton.classList.remove("btn-secondary"); 
                verifyOtpButton.classList.add("btn-verified"); // Use new style
                
                signupButton.disabled = false; // *** ENABLE SIGNUP ***
                
                // Also disable resend to prevent changes
                sendOtpButton.disabled = true;

            } catch (error) {
                showMessage(error.message, "error");
                verifyOtpButton.disabled = false;
                verifyOtpButton.textContent = "Verify";
            }
        });

        // --- Signup Form Submission ---
        signupForm.addEventListener("submit", (event) => {
            event.preventDefault();
            
            const phone_number = phoneInput.value; // Get the verified phone number
            const username = usernameInput.value;
            const email = emailInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (password !== confirmPassword) {
                showMessage("Passwords do not match. Please try again.", "error");
                return;
            }
            if (password.length < 8) {
                showMessage("Password must be at least 8 characters long.", "error");
                return;
            }
            if (!username || !email || !password) {
                showMessage("Please fill out all user details.", "error");
                return;
            }

            signupButton.disabled = true;
            signupButton.textContent = "Creating...";
            messageBox.style.display = "none";

            const signupData = {
                phone_number: phone_number,
                username: username,
                email: email,
                password: password
            };

            fetch('/api/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signupData)
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok) {
                    showMessage("Account created successfully! Redirecting to login...", "success");
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    throw new Error(data.msg || 'Signup failed.');
                }
            })
            .catch(error => {
                console.error('Signup failed:', error);
                if (error.message.includes("Unexpected token '<'")) {
                    showMessage("Server Error: Backend is not running or sent an HTML error page.", "error");
                } else {
                    showMessage(error.message, "error");
                }
                signupButton.disabled = false;
                signupButton.textContent = "Create Account";
            });
        });
    });
</script>
</body>
</html>